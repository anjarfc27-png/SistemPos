name: Build iOS IPA

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-14
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    
    - name: Create .env file
      run: |
        echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> .env
        echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env
    
    - name: Build web app
      run: npm run build
    
    - name: Install Capacitor CLI globally
      run: npm install -g @capacitor/cli@latest

    - name: Clean previous iOS build
      run: |
        rm -rf ios
        rm -rf node_modules/.cache

    - name: Add iOS platform
      run: npx cap add ios
    
    - name: Update Podfile deployment target
      run: |
        cd ios/App
        # Update to iOS 14.0 (minimum for Capacitor 7.x)
        sed -i.bak "s/platform :ios, '[0-9.]*'/platform :ios, '14.0'/" Podfile
        
        # Add post_install hook to set deployment target
        if ! grep -q "post_install do |installer|" Podfile; then
          cat >> Podfile << 'EOF'

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '14.0'
    end
  end
end
EOF
        fi
        
        echo "âœ… Updated Podfile:"
        cat Podfile
    
    
    - name: Update Info.plist with Camera & Bluetooth Permissions
      run: |
        PLIST_PATH="ios/App/App/Info.plist"
        echo "ðŸ“ Adding permissions to $PLIST_PATH"
        
        # Backup original
        cp $PLIST_PATH ${PLIST_PATH}.backup
        
        # Add camera permission descriptions
        /usr/libexec/PlistBuddy -c "Add :NSCameraUsageDescription string 'Aplikasi membutuhkan akses kamera untuk scan barcode produk'" $PLIST_PATH || true
        /usr/libexec/PlistBuddy -c "Add :NSPhotoLibraryUsageDescription string 'Aplikasi membutuhkan akses galeri foto untuk menyimpan nota'" $PLIST_PATH || true
        /usr/libexec/PlistBuddy -c "Add :NSPhotoLibraryAddUsageDescription string 'Aplikasi membutuhkan akses untuk menyimpan gambar nota ke galeri'" $PLIST_PATH || true
        
        # Add Bluetooth permissions
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothAlwaysUsageDescription string 'Aplikasi membutuhkan akses Bluetooth untuk koneksi dengan printer thermal'" $PLIST_PATH || true
        /usr/libexec/PlistBuddy -c "Add :NSBluetoothPeripheralUsageDescription string 'Aplikasi membutuhkan akses Bluetooth untuk koneksi dengan printer thermal'" $PLIST_PATH || true
        
        echo "âœ… Permissions added successfully!"
        echo "ðŸ“„ Info.plist content:"
        cat $PLIST_PATH
    
    - name: Copy web assets to iOS
      run: npx cap copy ios
    
    - name: Generate Capacitor Resources
      run: |
        npm install -g @capacitor/assets
        npx capacitor-assets generate --ios --iconBackgroundColor "#3b82f6" || echo "Skipping assets generation"
    
    - name: Sync Capacitor with force update
      run: npx cap sync ios --deployment
    
    - name: Install CocoaPods dependencies
      run: |
        cd ios/App
        pod install --repo-update --deployment
    
    - name: Build iOS app
      run: |
        cd ios/App
        xcodebuild -workspace App.xcworkspace \
          -scheme App \
          -configuration Debug \
          -destination 'generic/platform=iOS' \
          -archivePath $PWD/build/App.xcarchive \
          archive
    
    - name: Export IPA
      run: |
        cd ios/App
        
        # Create ExportOptions.plist
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>development</string>
          <key>teamID</key>
          <string></string>
          <key>compileBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <false/>
          <key>signingStyle</key>
          <string>automatic</string>
        </dict>
        </plist>
        EOF
        
        xcodebuild -exportArchive \
          -archivePath $PWD/build/App.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath $PWD/build/export
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: KasirQ-POS-ipa
        path: ios/App/build/export/*.ipa
    
    - name: Get current date
      if: github.ref == 'refs/heads/main'
      id: date
      run: echo "date=$(date +'%Y-%m-%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Create Release
      if: github.ref == 'refs/heads/main'
      id: create_release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ios-v${{ github.run_number }}-${{ steps.date.outputs.date }}
        name: KasirQ POS iOS v${{ github.run_number }}
        body: |
          ðŸš€ **KasirQ POS iOS IPA**
          
          Build: #${{ github.run_number }}
          Date: ${{ steps.date.outputs.date }}
          Commit: ${{ github.sha }}
          
          âœ¨ **Fitur Terbaru:**
          - âœ… Permission kamera untuk barcode scanner
          - âœ… Permission Bluetooth untuk thermal printer
          - âœ… Fixed header position di native app
          - âœ… Fixed layout mobile reports page
          - âœ… WhatsApp share dengan gambar
          - âœ… Grafik analytics tanpa legend
          - âœ… Grafik 1 bulan menampilkan data per hari
          
          ### Download & Install
          1. Download file IPA di bawah
          2. Install menggunakan Xcode atau tools seperti AltStore
          3. Trust developer profile di Settings > General > VPN & Device Management
          
        files: |
          ios/App/build/export/*.ipa
        draft: false
        prerelease: false
